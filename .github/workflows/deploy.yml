name: Deploy Backend to Homelab

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**"
      - "docker-compose.yml"
      - ".github/workflows/deploy.yml"

  # Permite disparar manualmente na aba "Actions" do GitHub
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOMELAB_HOST }}
          username: ${{ secrets.HOMELAB_USER }}
          key: ${{ secrets.HOMELAB_SSH_KEY }}
          port: ${{ secrets.HOMELAB_PORT }}
          script: |
            # 1. Navegar at√© a pasta do projeto
            cd ~/orfeu

            # 2. Baixar as mudan√ßas do GitHub
            git pull origin main

            # 3. LIMPEZA PREVENTIVA
            # Removemos for√ßadamente os containers antigos para evitar conflitos de nomes ou cache
            echo "üßπ Executando limpeza preventiva de containers..."
            docker rm -f orfeu_backend orfeu_slskd orfeu_db orfeu_pgadmin orfeu_tunnel || true

            # 4. Recriar o ambiente usando DOCKER COMPOSE V2 (Sem h√≠fen)
            # Isso evita o erro KeyError: 'ContainerConfig' das vers√µes antigas
            echo "üöÄ Subindo nova vers√£o..."
            docker compose up -d --build

            # 5. Limpeza de imagens antigas (opcional, economiza disco)
            docker image prune -f
