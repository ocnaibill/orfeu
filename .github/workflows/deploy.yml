name: Deploy Backend Only

on:
  push:
    branches: ["main"]
    paths:
      - "backend/**" # SÃ³ se mudar cÃ³digo Python
      - "docker-compose.yml" # Ou infraestrutura
      # Note que removemos mobile_app e updates.json daqui
  workflow_dispatch:

jobs:
  deploy_backend:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOMELAB_HOST }}
          username: ${{ secrets.HOMELAB_USER }}
          key: ${{ secrets.HOMELAB_SSH_KEY }}
          port: ${{ secrets.HOMELAB_PORT }}
          script: |
            cd ~/orfeu
            git pull origin main

            echo "ðŸ§¹ Limpeza preventiva..."
            docker rm -f orfeu_backend orfeu_slskd orfeu_db orfeu_pgadmin orfeu_tunnel || true

            echo "ðŸš€ Atualizando Backend..."
            docker compose up -d --build
            docker image prune -f
