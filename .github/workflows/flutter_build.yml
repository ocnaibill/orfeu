name: Build and Release Mobile App

on:
  push:
    branches: ["main"]
    paths:
      - "mobile_app/**" # Só roda se mexer no App
  workflow_dispatch:

jobs:
  # 1. Identificar Versão
  get_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - id: extract_version
        run: |
          VERSION=$(grep 'version:' mobile_app/pubspec.yaml | head -1 | awk '{print $2}' | cut -d+ -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # 2. Build Android
  build_android:
    needs: get_version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.16.x"
          channel: "stable"
      - uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Build APK
        run: |
          cd mobile_app
          flutter pub get
          flutter build apk --release
          mv build/app/outputs/flutter-apk/app-release.apk "Orfeu-v${{ needs.get_version.outputs.version }}.apk"

      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: mobile_app/*.apk

  # 3. Build Windows (Opcional se quiser economizar minutos do GitHub Actions)
  build_windows:
    needs: get_version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.16.x"
          channel: "stable"
      - name: Build Windows
        run: |
          cd mobile_app
          flutter pub get
          flutter build windows --release
          Compress-Archive -Path build\windows\runner\Release\* -DestinationPath "Orfeu-v${{ needs.get_version.outputs.version }}-windows.zip"
      - uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: mobile_app/*.zip

  # 4. Build macOS (Requer runner macOS, gasta mais "minutos" do GitHub)
  build_macos:
    needs: get_version
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.16.x"
          channel: "stable"
      - name: Build macOS
        run: |
          cd mobile_app
          flutter pub get
          flutter build macos --release
          # Zipar o .app é obrigatório para distribuição
          zip -r "Orfeu-v${{ needs.get_version.outputs.version }}-macos.zip" build/macos/Build/Products/Release/mobile_app.app
      - uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: mobile_app/*.zip

  # 5. Deploy Final (Upload para Homelab e Atualizar JSON)
  deploy_artifacts:
    needs: [get_version, build_android, build_windows, build_macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true # Junta tudo numa pasta só

      - name: Upload via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOMELAB_HOST }}
          username: ${{ secrets.HOMELAB_USER }}
          key: ${{ secrets.HOMELAB_SSH_KEY }}
          port: ${{ secrets.HOMELAB_PORT }}
          source: "artifacts/*"
          target: "/var/www/orfeu/downloads/" # Ajuste para onde seu servidor guarda arquivos estáticos
          strip_components: 1

      - name: Update JSON & Restart Backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOMELAB_HOST }}
          username: ${{ secrets.HOMELAB_USER }}
          key: ${{ secrets.HOMELAB_SSH_KEY }}
          port: ${{ secrets.HOMELAB_PORT }}
          script: |
            VERSION="${{ needs.get_version.outputs.version }}"

            # Atualiza o arquivo updates.json no servidor
            cat <<EOF > ~/orfeu/backend/updates.json
            {
              "latest_version": "$VERSION",
              "release_notes_pt": "Atualização automática via CI/CD.",
              "platforms": {
                "android": { "url": "https://orfeu.ocnaibill.dev/downloads/Orfeu-v$VERSION.apk" },
                "windows": { "url": "https://orfeu.ocnaibill.dev/downloads/Orfeu-v$VERSION-windows.zip" },
                "macos": { "url": "https://orfeu.ocnaibill.dev/downloads/Orfeu-v$VERSION-macos.zip" }
              }
            }
            EOF

            # Reinicia o backend para ele ler a nova versão
            cd ~/orfeu
            docker compose restart backend
